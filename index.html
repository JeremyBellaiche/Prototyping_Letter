<!doctype html>
<html>
<head>
  <title>Socket.IO chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">	
  <link rel="stylesheet" href="css/style.css">
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
</head>
<body>

  <input id="blur-hack" type="text" style="position: absolute; opacity: 0;">

  <footer>
    <div class="container-fluid">    
      <form action="">
        <input placeholder="Enter your message" id="m" autocomplete="off" />
        <!-- <button>Send</button> -->
      </form>
    </div>  
  </footer>
  <header>
    <div class="container">    
      Actual : <span id="version"></span> <a class="btn btn-info pull-right" id="changeVersion">Change</a>
    </div>
  </header>

  <section>
    <div class="container">    
      <ul id="messages">
      </ul>
    </div>
<!--     <ul id="messages">
      <li class="someone" style="display: none;"></li>
    </ul> -->
  </section>

  <div class="clearfix"></div>
  <div id="bottom"></div>

  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    var socket = io();
    var version = 'letters';

    // Launch the prompt modal
    function hasWhiteSpace(s) {
      return /\s/g.test(s);
    }

    var userId = prompt('What is your name ? Without spaces !');

    function scrollToBottom(){
      document.getElementById( 'bottom' ).scrollIntoView();
    }
    // SET UP VERSION HTML CODE
    $('#version').html(version);

    $('#changeVersion').on('click', function(){
      if(version == 'letters'){
        version = 'words';      
      }
      else{
        version = 'letters';
      }
      $('#version').html(version);
    });
    // METHODS
    $('form').submit(function(){
      if($('#m').val() != ''){
        var msg = {
          'message' : $('#m').val(),
          'author' : userId 
        };
        console.log(userId);
        socket.emit('send message', msg);
        $('#m').val('');
      }
      // Unfocus the M to show the message
      $('#m').blur();
      return false;
    })

    $(document).keypress(function(e) {
      var charTyped = String.fromCharCode(e.which);
      if (/[a-z\d]/i.test(charTyped)) {
        if($('#m').val() !== ''){
          $('#m').focus();
        }
        else{
         $('#m').val(charTyped);
        }
      }
    });

    $('input').on('keyup', function(event){
      if(version == 'letters'){    
        var msg = {
          'message': $('#m').val(),
          'author' : userId
        };
        socket.emit('write message', msg);
        return false;
      }
      else{
        // Version if for spaces
        if(event.keyCode == 32){
          // It's a space
          var msg = {
            'message': $('#m').val(),
            'author' : userId
          };
          socket.emit('write message', msg);
          return false;
        }
      }
    })

    // USER IS WRITING A MESSAGE
    socket.on('write message', function(msg){
      $('#messages li#'+msg.author).remove();
      if(msg.author != userId && msg.message !== ''){
        $('#messages').append('<li id="'+msg.author+'" class="someone"><span class="author">'+msg.author+'</span><p>'+msg.message+'</p></li>');
        scrollToBottom();
      }
      else{
      }
    });


    // USER CLICK ON SEND ON A MESSAGE
    socket.on('send message', function(msg){
      if(msg.author == userId){
        // Current user
        // $('#messages').append( $('<li>').addClass('me').text(msg.message) )
        $('#messages').append('<li class="me"><span class="author">'+msg.author+'</span><p>'+msg.message+'</p></li>');
      }
      else{
        // $('#messages').append( $('<li>').addClass('you').text(msg.message) ) 
        $('#messages li#'+msg.author).remove();
        $('#messages').append('<li class="someone"><span class="author">'+msg.author+'</span><p>'+msg.message+'</p></li>');

      }
      scrollToBottom();

    });

  </script>
</body>
</html>
